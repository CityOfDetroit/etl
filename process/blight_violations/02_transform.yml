- type: sql
  statements:
    # create a master table
    - drop table if exists dah.bvn cascade
    - create table dah.bvn (
        ticket_id bigint,
        ticket_number text,
        agency_name text,
        inspector_name text,
        violator_name text,
        violation_street_number text,
        violation_street_name text,
        violation_zip_code text,
        violator_id bigint,
        mailing_address_str_number text,
        mailing_address_str_name text,
        city text,
        state text,
        zip_code text,
        non_us_str_code text,
        country text,
        violation_date timestamp,
        ticket_issued_time text,
        hearing_date timestamp,
        hearing_time text,
        violation_code text,
        violation_description text,
        disposition text,
        fine_amount double precision,
        admin_fee double precision,
        state_fee double precision,
        late_fee double precision,
        discount_amount double precision,
        clean_up_cost double precision,
        judgment_amount double precision,
        payment_amount double precision,
        balance_due double precision,
        payment_date timestamp,
        payment_status text,
        collection_status text,
        violation_address text,
        parcelno text,
        latitude double precision,
        longitude double precision,
        location text);
    # create indices on helper tables. speeds up ze joins
    - create index if not exists dah_bvn_zticket_idx on dah.bvn using btree(ticket_id);
    - create index if not exists dah_violator_info_idx on dah.violator_info using btree("ZTicketID");
    - create index if not exists dah_violator_address_idx on dah.violator_address using btree("ViolatorID");
    - create index if not exists dah_payment_id_idx on dah.payments using btree("ZticketID");
    # start joins
    - insert into dah.bvn (
        ticket_id,
        ticket_number,
        agency_name,
        inspector_name,
        violation_street_number,
        violation_street_name,
        violation_zip_code,
        violator_id,
        violation_date,
        ticket_issued_time,
        hearing_date,
        hearing_time,
        violation_code,
        violation_description,
        fine_amount,
        late_fee,
        admin_fee,
        state_fee,
        discount_amount,
        clean_up_cost
      )
      select
        "ZTicketID",
        "TicketNumber",
        # agency name
        (select "AgencyName" from dah.agency ag where ag."AgencyID" = z."AgencyID"),
        # inspector_name
        (select concat_ws(' ', s."UserFirstName", s."UserLastName") from dah.security s where z."ZTicketUserID" = s."SecurityID"),
        # violation_street_number
        "ViolStreetNumber",
        # violation_street_name
        (select "StreetName" from dah.streets s where s."StreetID" = z."ViolStreetName"),
        # violation_zip_code
        "ViolZipCode",
        (select "FileID" from dah.violator_info vi where vi."ZTicketID" = z."ZTicketID" ),
        "IssueDate"::timestamp,
        "IssueTime",
        # court_date - account for rescheduling
        (CASE
          WHEN ("ZTicketID" in (select "ZTicketID" from dah.reschedule)) THEN (select "ReScheduleDate" from dah.reschedule r where z."ZTicketID" = r."ZTicketID" order by "ReScheduleDate" desc limit 1)
          ELSE "CourtDate"
        END),
        # court_time
        (CASE 
          WHEN "CourtTime" = 1.0 THEN '9:00 AM'
          WHEN "CourtTime" = 2.0 THEN '10:30 AM'
          WHEN "CourtTime" = 3.0 THEN '1:30 PM'
          WHEN "CourtTime" = 4.0 THEN '3:00 PM'
          WHEN "CourtTime" = 5.0 THEN '6:00 PM'
          ELSE null
        END),
        # violation_code
        (select "OrdLaw" from dah.ordinance od where z."ViolDescID" = od."OrdID"),
        # violation_description
        (select "OrdDescription" from dah.ordinance od where z."ViolDescID" = od."OrdID"),
        # fine_amount
        (select "OffFineAmt" from dah.cityfines cf where z."OrigFineAmt" = cf."OffFinID"),
        "LateFee",
        "AdminFee",
        "JSA",
        "DiscAmt",
        # remediation cost
        (select sum("ServiceCost") from dah.blight_ticket_svc_cost bts where z."ZTicketID" = bts."ZTicketID" and bts."ServiceType" = 6)
      from dah.ztickets z where z."VoidTicket" = 0; --order by random() limit 5000;
    # new fine amount
    - update dah.bvn j set fine_amount = z."NewFineAmt" from dah.ztickets z 
        where j.ticket_id = z."ZTicketID" and z."NewFineAmt" > 0;
    # join violator info
    - update dah.bvn j set
        violator_name = 
          CASE
            WHEN i."BusinessName" is not null THEN i."BusinessName"
            ELSE concat_ws(' ', i."FirstName", i."LastName")
          END
      from dah.violator_info i where j.ticket_id = i."ZTicketID";
    # join voilator address
    - update dah.bvn j set
        mailing_address_str_number = a."StreetNumber",
        mailing_address_str_name = a."StreetName",
        city = a."City",
        state = (select "StateAbrev" from dah.state s where s."StateID" = a."StateID"),
        zip_code = a."ZipCode",
        non_us_str_code = a."NonUsCity",
        country = (select "CountryDesc" from dah.country c where c."CountryID"::text = a."CountryID"::text)
      from dah.violator_address a where a."ViolatorID" = j.violator_id;
    # join dah payments
    - update dah.bvn j set
	      admin_fee = p."AdminFee",
	      state_fee = p."StateFee"
      from dah.payments p where j.ticket_id = p."ZticketID";
    # compute judgment amount: sum OrigFineAmt, AdminFee, StateFee, LateFee, RemediationCost, minus DiscAmt
    - update dah.bvn j
	      set judgment_amount = (
		      COALESCE(fine_amount, 0) + 
		      COALESCE(admin_fee, 0) + 
          COALESCE(state_fee, 0) + 
          COALESCE(late_fee, 0) + 
          COALESCE(clean_up_cost, 0) -
          COALESCE(discount_amount, 0));
    # compute payment amount: sum all rows with PaymentAmt for a unique ZTicketID
    - update dah.bvn j set
	      payment_amount = (select sum("PaymentAmt") from dah.payments where "ZticketID" = j.ticket_id);
    - update dah.bvn j set
        payment_amount = judgment_amount
            where j.ticket_id in (select "ZticketID" from dah.payments where "PymtKnd" = 2);
    # compute balance due
    - update dah.bvn j
        set balance_due = (judgment_amount - COALESCE(payment_amount, 0));
    
     


