- type: sql
  statements: 
  - create index estinfo_recordid_idx on health.estinfo (recordid)
  - create index zip_recordid_idx on health.zipcode (recordid)
  - create index etype_recordid_idx on health.etype (recordid)
  - create index estatus_recordid_idx on health.estatus (recordid)
  - create index riskcategory_recordid_idx on health.riskcategory (recordid)
  - create index iheader_estid_idx on health.iheader (establishmentid)
  - create index iheader_date_idx on health.iheader (date)
  
- type: create_table
  table_name: establishments
  as: select 
        e.recordid,
        name,
        trim(trailing '.' from regexp_replace(address1, '\.','')) as address,
        (select rtrim(z.zipcode, '-0000') from health.zipcode z where z.recordid::text = rtrim(e.zip, '.0')) as zipcode,
        owner,
        license,
        lictype,
        (select t.description from health.etype t where t.recordid::text = rtrim(e.type, '.0')) as establishment_type,
        (select es.description from health.estatus es where es.recordid::text = rtrim(e.status, '.0')) as establishment_status,
        (select r.description from health.riskcategory r where r.recordid::text = (select substring(e.riskfactor, 1, 1))) as complexity,
        lastinspection::timestamp,
        nextinspection::timestamp,
        reviewfrequency,
        (select i.inspectionid from health.iheader i where rtrim(i.establishmentid::text, '.0') = e.recordid::text and i.date::timestamp = e.lastinspection::timestamp order by i.date desc limit 1) as last_inspectionid,
        (select i.compliance from health.iheader i where rtrim(i.establishmentid::text, '.0') = e.recordid::text and i.date::timestamp = e.lastinspection::timestamp order by i.date desc limit 1) as last_inspection_compliance
      from health.estinfo e
      where lastinspection::timestamp between date '2016-08-01' and now() - interval '30 DAYS'

- type: geocode
  table: health.establishments
  add_col: address
  geom_col: geom

- type: create_view
  view_name: establishments_socrata
  as: select
        recordid as establishmentid,
        name,
        address,
        zipcode,
        owner,
        (select handleNan(license)) as license_number,
        lictype as license_type,
        establishment_type,
        initcap(establishment_status) as establishment_status,
        case
          when complexity = 'Z' then 'High risk'
          when complexity = 'Y' then 'Medium risk'
          when complexity = 'X' then 'Low risk'
          else null
        end as risk_category,
        (select makeSocrataDate(lastinspection)) as last_inspection_date,
        last_inspectionid,
        initcap(last_inspection_compliance) as last_inspection_compliance,
        (select makeSocrataDate(nextinspection)) as next_inspection_date,
        (select handleNan(reviewfrequency)) as review_frequency_days,
        (select makeSocrataLocation(geom)) as location
      from health.establishments
