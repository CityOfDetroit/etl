- type: sql
  statements:
    - alter table pubsafe.cad_update add column if not exists is_anon boolean
    - update pubsafe.cad_update set is_anon = 'f'
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'DETROIT$', ''))
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'ALLE$', ''))
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'DEAR$', ''))
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'DEARBORN$', ''))
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'ECOR$', ''))
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'FERN$', ''))
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'GROS$', ''))
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'HAMT$', ''))
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'HAZE$', ''))
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'HIGH$', ''))
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'REDF$', ''))
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'RIVE$', ''))
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'ROYA$', ''))
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'SOUT$', ''))
    - update pubsafe.cad_update set incident_address = trim(regexp_replace(incident_address, 'WARR$', ''))
    - <remove apartments>
    - <remove double white space>
- type: lookup
  table: pubsafe.cad_update
  lookup_field: incident_address
  file: process/cad_rms/misfits_lookup.csv
  match_field: geoc_address
  method: match
  set_flag: false
- type: lookup
  table: pubsafe.cad_update
  lookup_field: incident_address
  file: process/cad_rms/misfits_lookup.csv
  match_field: anon_return
  method: match
  set_flag: true
- type: lookup
  table: pubsafe.cad_update
  lookup_field: incident_address
  file: process/cad_rms/redacted_lookup.csv
  match_field: new
  method: contains
  set_flag: true

# Add geometry here
- type: sql
  statements:
    - select AddGeometryColumn('pubsafe', 'cad_update', 'geom', 2898, 'POINT', 2)
    - create index etl_cad_update_geom_idx on pubsafe.cad_update using gist(geom)
    - update pubsafe.cad_update set geom = st_setsrid(st_makepoint(geox, geoy), 2898) where geox > 0 and geoy > 0

# Stamp with District/Neighborhood/Block/ZipCode

# Fuzz text location
- type: anonymize_text_location
  table: pubsafe.cad_update
  column: incident_address
  set_flag: True

# Fuzz geometry
- type: anonymize_geometry
  table: pubsafe.cad_update
  against: base.centerline

- type: sql
  statements:
    - update pubsafe.cad_update set incident_address = 'Location Redacted' where is_anon = 'f'
#   - insert into pubsafe.cad (select * from pubsafe.cad_update)
    - 'alter table pubsafe.cad_update drop column geox'
    - 'alter table pubsafe.cad_update drop column geoy'

