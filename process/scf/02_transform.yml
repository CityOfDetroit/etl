# Create views
- type: sql
  statements:
    # Add extra cols
    - alter table scf.issues_update add column if not exists canonical_issue_id float
    - update scf.issues_update set canonical_issue_id = 'NaN' where canonical_issue_id is null
    - alter table scf.issues_update add column if not exists days_to_close interval
    - update scf.issues_update set days_to_close = (closed_at::timestamp - created_at::timestamp) where closed_at != 'NaN'

    # Add geometry
    - select AddGeometryColumn('scf', 'issues_update', 'geom', 4326, 'POINT', 2)
    - create index etl_scf_update_geom_idx on scf.issues_update using gist(geom)
    - update scf.issues_update set geom = st_setsrid(st_makepoint(lng, lat), 4326) where lat is not null and lng is not null

    # Translate geom to 2898 to join to base
    - alter table scf.issues_update alter column geom type geometry(Point,2898) using st_transform(geom,2898)

    # Stamp with Neighborhood & Council District
    - alter table scf.issues_update add column neighborhood varchar(100)
    - update scf.issues_update r set neighborhood = n.name from base.neighborhoods n where st_contains(n.wkb_geometry, r.geom)
    - alter table scf.issues_update add column council_district integer
    - update scf.issues_update r set council_district = d.districts::integer from base.council_districts d where st_contains(d.wkb_geometry, r.geom)

    # Insert updates into master table
    - delete from scf.issues where id in (select id from scf.issues_update)
    - insert into scf.issues 
        (acknowledged_at,
        address,
        closed_at,
        created_at,
        description,
        id,
        lat,
        lng,
        priority_code,
        reopened_at,
        report_method,
        request_type_title,
        status,
        updated_at,
        canonical_issue_id,
        days_to_close,
        neighborhood,
        council_district )
        select
        acknowledged_at,
        address,
        closed_at,
        created_at,
        description,
        id,
        lat,
        lng,
        priority_code,
        reopened_at,
        report_method,
        request_type_title,
        status,
        updated_at,
        canonical_issue_id,
        days_to_close,
        neighborhood,
        council_district
        from scf.issues_update

    # Create views
    - drop view if exists scf.issues_socrata
    - create view scf.issues_socrata as
            ( select
              id,
              status,
              request_type_title,
              description,
              case
                when id is null
                then null
                else concat('https://seeclickfix.com/issues/', id)
              end as web_url,
              report_method,
              priority_code,
              case
                when created_at = 'NaN'
                then null
                else replace(to_char(created_at::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
              end as created_at,
              case
                when acknowledged_at = 'NaN'
                then null 
                else replace(to_char(acknowledged_at::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
              end as acknowledged_at,
              case
                when closed_at = 'NaN'
                then null
                else replace(to_char(closed_at::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
              end as closed_at,
              case
                when reopened_at = 'NaN'
                then null 
                else replace(to_char(reopened_at::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
              end as reopened_at,
              case
                when updated_at = 'NaN'
                then null
                else replace(to_char(updated_at::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
              end as updated_at,
              days_to_close,
              case 
                when canonical_issue_id = 'NaN'
                then null
                else canonical_issue_id
              end as canonical_issue_id,
              address,
              neighborhood,
              council_district,
              case when lat is null then null else
                concat(
                  'location (',
                  lat,
                  ',',
                  lng,
                  ')'
                )
              end as location
            from scf.issues
            where request_type_title not in ('Abandoned Vehicle', 'Illegal Dumping In Progress'))
    - drop view if exists scf.issues_socrata_private
    - create view scf.issues_socrata_private as
            ( select
              id,
              status,
              request_type_title,
              description,
              case
                when id is null
                then null
                else concat('https://seeclickfix.com/issues/', id)
              end as web_url,
              report_method,
              priority_code,
              case
                when created_at = 'NaN'
                then null
                else replace(to_char(created_at::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
              end as created_at,
              case
                when acknowledged_at = 'NaN'
                then null 
                else replace(to_char(acknowledged_at::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
              end as acknowledged_at,
              case
                when closed_at = 'NaN'
                then null
                else replace(to_char(closed_at::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
              end as closed_at,
              case
                when reopened_at = 'NaN'
                then null 
                else replace(to_char(reopened_at::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
              end as reopened_at,
              case
                when updated_at = 'NaN'
                then null
                else replace(to_char(updated_at::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
              end as updated_at,
              days_to_close,
              case 
                when canonical_issue_id = 'NaN'
                then null
                else canonical_issue_id
              end as canonical_issue_id,
              address,
              neighborhood,
              council_district,
              case when lat is null then null else
                concat(
                  'location (',
                  lat,
                  ',',
                  lng,
                  ')'
                )
              end as location
            from scf.issues )
    # - drop table if exists scf.issues_update cascade

 # Copy view to a csv
- type: sql
  statements:
  - copy ( select * from scf.issues_socrata_private ) to '/tmp/311.csv' delimiter ',' csv header
  