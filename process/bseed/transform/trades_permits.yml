- type: create_table
  table_name: trade_permits
  as: select
        permit_no,             
        permit_issued,        
        permit_expire,         
        permit_completed,      
        permit_status,         
        site_address,          
        between1,              
        parcel_no,             
        prc_lot,               
        prc_subdiv,            
        case_type,             
        case_description,      
        legal_use,             
        estimated_cost,        
        parcel_size,           
        parcel_cluster_sector, 
        stories,               
        parcel_floor_area,     
        parcel_ground_area,    
        prc_aka_address,       
        elv_type_of_work,              
        permit_description,    
        fdicn_description,     
        elv_type_of_use,               
        residential,           
        description,           
        elv_type_const_cod,    
        elv_zoning_dist,       
        elv_use_group,        
        elv_basement,          
        fee_type,              
        csm_caseno,            
        csf_created_by,        
        seq_no,                
        pcf_amt_due,           
        owner_name,            
        owner_address1,       
        contractor_last_name,  
        contractor_address1 
      from bseed.tm_elevator union all
      select
        permit_no,             
        permit_applied,        
        permit_expire,         
        permit_completed,      
        permit_status,         
        site_address,          
        between1,              
        parcel_no,             
        prc_lot,               
        prc_subdiv,            
        case_type,             
        case_description,      
        legal_use,             
        estimated_cost,        
        parcel_size,           
        parcel_cluster_sector, 
        stories,               
        parcel_floor_area,     
        parcel_ground_area,    
        prc_aka_address,       
        plm_work,              
        permit_description,    
        fdicn_description,     
        plm_use,               
        residential,           
        description,           
        plm_type_const_cod,    
        plm_zoning_dist,       
        plm_use_group,        
        plm_basement,          
        fee_type,              
        csm_caseno,            
        csf_created_by,        
        seq_no,                
        pcf_amt_due,           
        owner_name,            
        owner_address1,       
        contractor_last_name,  
        contractor_address1
      from bseed.tm_plumbing union all
      select
        permit_no,             
        permit_issued,        
        permit_expire,         
        permit_completed,      
        permit_status,         
        site_address,          
        between1,              
        parcel_no,             
        prc_lot,               
        prc_subdiv,            
        case_type,             
        case_description,      
        legal_use,             
        estimated_cost,        
        parcel_size,           
        parcel_cluster_sector, 
        stories,               
        parcel_floor_area,     
        parcel_ground_area,    
        prc_aka_address,       
        ele_type_work,              
        permit_description,    
        fdicn_description,     
        ele_type_use,               
        residential,           
        description,           
        ele_type_const_cod,    
        ele_zoning_dist,       
        ele_use_group,        
        ele_basement,          
        fee_type,              
        csm_caseno,            
        csf_created_by,        
        seq_no,                
        pcf_amt_due,           
        owner_name,            
        owner_address1,       
        contractor_last_name,  
        contractor_address1
      from bseed.tm_electrical union all
      select
        permit_no,             
        permit_issued,        
        permit_expire,         
        permit_completed,      
        permit_status,         
        site_address,          
        between1,              
        parcel_no,             
        prc_lot,               
        prc_subdiv,            
        case_type,             
        case_description,      
        legal_use,             
        estimated_cost,        
        parcel_size,           
        parcel_cluster_sector, 
        stories,               
        parcel_floor_area,     
        parcel_ground_area,    
        prc_aka_address,       
        bpv_type_work,              
        permit_description,    
        fdicn_description,     
        bpv_type_use,               
        residential,           
        description,           
        bpv_type_const_cod,    
        bpv_zoning_dist,       
        bpv_use_group,        
        bpv_basement,          
        fee_type,              
        csm_caseno,            
        csf_created_by,        
        seq_no,                
        pcf_amt_due,           
        concat_ws(' ', owner_first_name, owner_last_name),            
        owner_address1,       
        contractor_last_name,  
        contractor_address1
      from bseed.tm_boiler union all
      select
        permit_no,             
        permit_issued,        
        permit_expire,         
        permit_completed,      
        permit_status,         
        site_address,          
        between1,              
        parcel_no,             
        prc_lot,               
        prc_subdiv,            
        case_type,             
        case_description,      
        legal_use,             
        estimated_cost,        
        parcel_size,           
        parcel_cluster_sector, 
        stories,               
        parcel_floor_area,     
        parcel_ground_area,    
        prc_aka_address,       
        mec_work,              
        permit_description,    
        fdicn_description,     
        mec_use,               
        residential,           
        description,           
        mec_type_const_cod,    
        mec_zoning_dist,       
        mec_use_group,        
        mec_basement,          
        fee_type,              
        csm_caseno,            
        csf_created_by,        
        seq_no,                
        pcf_amt_due,           
        owner_name,            
        owner_address1,       
        contractor_last_name,  
        contractor_address1
      from bseed.tm_mechanical

- type: sql
  statements:
    - update bseed.trade_permits tp set parcel_no = pl.cleaned from bseed.pnum_lookup pl where tp.parcel_no = pl.dirty
    - alter table bseed.trade_permits rename column elv_type_of_work to type_of_work
    - alter table bseed.trade_permits rename column elv_type_of_use to type_of_use
    - alter table bseed.trade_permits rename column elv_type_const_cod to type_const_cod
    - alter table bseed.trade_permits rename column elv_zoning_dist to zoning_dist
    - alter table bseed.trade_permits rename column elv_use_group to use_group
    - alter table bseed.trade_permits rename column elv_basement to basement
    - alter table bseed.trade_permits add column uniq serial primary key
    - update bseed.trade_permits set 
        site_address = regexp_replace(site_address, '[\s]{2,}', ' '),
        owner_address1 = regexp_replace(owner_address1, '[\s]{2,}', ' '),
        contractor_address1 = regexp_replace(contractor_address1, '[\s]{2,}', ' ')
    - create index if not exists bseed_trade_permits_idx on bseed.trade_permits using btree(site_address)

- type: geocode
  table: bseed.trade_permits
  add_col: site_address
  geom_col: geom

- type: create_view
  view_name: trades_permits_socrata
  as: select
        uniq as unique_id, 
        permit_no as permit_no,
        (select makeSocrataDate(permit_issued)) as permit_issued,
        (selecct makeSocrataDate(permit_expire)) as permit_expire,
        (select makeSocrataDate(permit_completed)) as permit_completed,
        permit_status as permit_status, 
        site_address as site_address, 
        between1 as between1, 
        prc_lot as prc_lot, 
        prc_subdiv as prc_subdiv, 
        case_type as case_type, 
        case_description as case_description,
        type_of_use as type_of_use, 
        description as type_use_desc, 
        type_of_work as permit_type, 
        permit_description as permit_type_desc, 
        fdicn_description as fdicn_description, 
        fee_type as fee_type, 
        (select handleNan(parcel_size)) as parcel_size,
        parcel_cluster_sector as parcel_cluster_sector, 
        (select handleNan(parcel_floor_area)) as parcel_floor_area, 
        (select handleNan(parcel_ground_area)) as parcel_ground_area,
        prc_aka_address as prc_aka_address, 
        seq_no as seq_no, 
        pcf_amt_due as pcf_amt_due, 
        owner_name as owner_name, 
        owner_address1 as owner_address, 
        contractor_last_name as contractor_name, 
        contractor_address1 as contractor_address, 
        (select makeSocrataLocation(geom)) as location
      from bseed.trade_permits
