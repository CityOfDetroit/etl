- type: sql
  statements:
    - drop view if exists dlba.auction_sold_socrata
    - create view dlba.auction_sold_socrata as
            ( select
            case when a.actual_closing_date is null then null else
                concat_ws('T', a.actual_closing_date, '00:00:00.000Z')
            end as actual_closing_date,
            a.sale_status,
            c.address,
            c.parcel_id,
            'Auction'::text as program,
            c.neighborhood,
            c.council_district,
            c.acct_latitude,
            c.acct_longitude,
            pb.buyer_status,
            case 
                when pb.final_sale_price = 'NaN' 
                then null 
                else pb.final_sale_price 
            end as final_sale_price,
            pb.purchaser_type,
            case 
                when c.acct_latitude is null 
                then null 
                else
                concat(
                    'location (',
                    c.acct_latitude,
                    ',',
                    c.acct_longitude,
                    ')'
                )
            end as location
            from dlba.dlba_activity a
            inner join dlba.case c on a.case = c.id
            inner join dlba.prospective_buyer pb on pb.dlba_activity = a.id
            where a.recordtypeid = '012j0000000xtGoAAI' 
            and a.sale_status = 'Closed'
            and pb.buyer_status = 'Selected'
            and c.address not like '%Fake St%' );
    - drop view if exists dlba.commercial_demos_socrata
    - create view dlba.commercial_demos_socrata as
        ( select
            name,
            commercial_demo_status,
            case when bseed_com_final_grade_approved is null then null else
                replace(to_char(bseed_com_final_grade_approved::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
            end as bseed_com_final_grade_approved,
            case when bseed_com_open_hole_approved is null then null else
                replace(to_char(bseed_com_open_hole_approved::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
            end as bseed_com_open_hole_approved,
            case when bseed_com_winter_grade_approved is null then null else
                replace(to_char(bseed_com_winter_grade_approved::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
            end as bseed_com_winter_grade_approved,
            case when final_grade_approved_dt is null then null else
                replace(to_char(final_grade_approved_dt::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
            end as final_grade_approved_dt,
            case when open_hole_approved_dt is null then null else
                replace(to_char(open_hole_approved_dt::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
            end as open_hole_approved_dt,
            case when winter_grade_approved_dt is null then null else
                replace(to_char(winter_grade_approved_dt::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
            end as winter_grade_approved_dt,
            case when demo_cost_abatement = 'NaN' then 0 else demo_cost_abatement end,
            case when demo_cost_knock = 'NaN' then 0 else demo_cost_knock end,
            case when demo_ntp_dt is null then null else
                replace(to_char(demo_ntp_dt::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
            end as demo_ntp_dt,
            case when demo_proj_demo_dt is null then null else
                replace(to_char(demo_proj_demo_dt::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
            end as demo_proj_demo_dt,
            case when demo_pulled_date is null then null else
                replace(to_char(demo_pulled_date::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
            end as demo_pulled_date,
            case when env_demo_proceed_dt is null then null else
                replace(to_char(env_demo_proceed_dt::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
            end as env_demo_proceed_dt,
            env_group_number,
            case when knock_start_dt is null then null else
                replace(to_char(knock_start_dt::timestamp, 'YYYY-MM-DD HH24:MM:SS'), ' ', 'T')
            end as knock_start_dt,
            demolition_contractor,
            dba_com_property_latitude,
            dba_com_property_longitude,
            dba_com_property_name,
            dba_com_property_neighborhood,
            dba_com_property_council_district,
            case when bseed_com_final_grade_approved is null then final_grade_approved_dt else
                bseed_com_final_grade_approved
            end as final_grade_date,
            case when bseed_com_open_hole_approved is null then open_hole_approved_dt else
                bseed_com_open_hole_approved
            end as open_hole_date,
            case when bseed_com_winter_grade_approved is null then winter_grade_approved_dt else
                bseed_com_winter_grade_approved
            end as winter_grade_date,
            case when (demo_cost_abatement+demo_cost_knock) = 'NaN' then null else (demo_cost_abatement+demo_cost_knock) end as total_demo_cost,
            case when dba_com_property_latitude is null then null else
                concat(
                    'location (',
                    dba_com_property_latitude,
                    ',',
                    dba_com_property_longitude,
                    ')'
                )
            end as location
        from dlba.dba_commercial_demo
        where (knock_start_dt::timestamp >= date '2014-01-01'
            or knock_start_dt is null)
            and commercial_demo_status in ('Demo Contracted', 'Demolished', 'Demo Pipeline') 
            and demo_pulled_date is not null )
    - drop view if exists dlba.for_sale_socrata
    - create view dlba.for_sale_socrata as
        ( select 
            c.address,
            c.parcel_id,
            c.program,
            case when a.listing_date is null then null else
                concat_ws('T', a.listing_date, '00:00:00.000Z')
            end as listing_date,
            c.neighborhood,
            c.council_district,
            c.acct_latitude,
            c.acct_longitude,
            case when c.acct_latitude is null then null else
                concat(
                    'location (',
                    c.acct_latitude,
                    ',',
                    c.acct_longitude,
                    ')'
                )
            end as location
            from dlba.dlba_activity a
            inner join dlba.case c on a.case = c.id
            where (a.recordtypeid = '012j0000000xtGoAAI'
                or a.dlba_activity_type in ('Demo Pull Sale', 'Demo Pull for Demo Sale', 'Renovation Sale', 'Own It Now', 'Own It Now - Bundled Property', 'Auction - Bundled Property'))
                and a.listing_date::timestamp < now() + interval '1 day'
                and a.sale_status = 'For Sale on Site'
                and c.status = 'For Sale'
                and c.address not like '%Fake St%' )
    - drop view if exists dlba.own_it_now_socrata
    - create view dlba.own_it_now_socrata as
        ( select 
            case when a.actual_closing_date is null then null else
                concat_ws('T', a.actual_closing_date, '00:00:00.000Z')
            end as actual_closing_date,
            a.sale_status,
            c.address,
            c.parcel_id,
            c.program,
            c.neighborhood,
            c.council_district,
            c.acct_latitude,
            c.acct_longitude,
            pb.buyer_status,
            case when pb.final_sale_price = 'NaN' then null else pb.final_sale_price end,
            pb.purchaser_type,
            case when c.acct_latitude is null then null else
                concat(
                    'location (',
                    c.acct_latitude,
                    ',',
                    c.acct_longitude,
                    ')'
                )
            end as location
        from dlba.dlba_activity a
        inner join dlba.case c on a.case = c.id
        inner join dlba.prospective_buyer pb on pb.dlba_activity = a.id
        where a.dlba_activity_type in ('Demo Pull Sale', 'Demo Pull for Demo Sale', 'Own It Now', 'Own It Now - Bundled Property')
            and a.actual_closing_date is not null
            and pb.buyer_status = 'Selected'
            and c.address not like '%Fake St%' )
    - drop view if exists dlba.side_lots_socrata
    - create view dlba.side_lots_socrata as 
        ( select
            a.actual_closing_date,
            a.sale_status,
            c.address,
            c.parcel_id,
            c.program,
            c.neighborhood,
            c.council_district,
            c.acct_latitude,
            c.acct_longitude,
            pb.buyer_status,
            pb.final_sale_price,
            pb.purchaser_type,
            case when c.acct_latitude is null then null else
                concat(
                    'location (',
                    c.acct_latitude,
                    ',',
                    c.acct_longitude,
                    ')'
                )
            end as location
            from dlba.dlba_activity a
            inner join dlba.case c on a.case = c.id
            inner join dlba.prospective_buyer pb on pb.dlba_activity = a.id
            where a.recordtypeid = '012j0000000xtGvAAI'
                and a.actual_closing_date is not null
                and pb.buyer_status = 'Selected'
                and c.address not like '%Fake St%' )
    - drop view if exists dlba.upcoming_demos_socrata
    - create view dlba.upcoming_demos_socrata as 
        ( select 
            address,
            case when demo_planned_knock_down_date is null then socrata_projected_knocked_by_date else demo_planned_knock_down_date end as demo_planned_knock_down_date,
            socrata_projected_knocked_by_date,
            case when socrata_reported_price = 'NaN' then null else socrata_reported_price end,
            parcel_id,
            demo_contractor_text_only,
            acct_latitude,
            acct_longitude,
            council_district,
            non_hhf_commercial_demo,
            socrata_price_type,
            demo_ntp_date,
            neighborhood,
            case when acct_latitude is null then null else
                concat(
                    'location (',
                    acct_latitude,
                    ',',
                    acct_longitude,
                    ')'
                )
            end as location
            from dlba.case
            where socrata_projected_knocked_by_date is not null
                and socrata_reported_price > 0
                and demo_contractor_text_only <> ''
                and status = 'Demo Contracted' )
    - drop view if exists dlba.completed_demos_socrata
    - create view dlba.completed_demos_socrata as
        ( select
            address,
            parcel_id,
            demo_contractor_text_only,
            case when socrata_reported_price = 'NaN' then null else socrata_reported_price end,
            case when demo_knock_down_date is null then null else
                replace(to_char(demo_knock_down_date::timestamp, 'YYYY-MM-DD HH24:MI:SS'), '', 'T')
            end as demo_knock_down_date,
            non_hhf_commercial_demo,
            council_district,
            neighborhood,
            acct_latitude,
            acct_longitude,
                        case when acct_latitude is null then null else
                concat(
                    'location (',
                    acct_latitude,
                    ',',
                    acct_longitude,
                    ')'
                )
            end as location
        from dlba.case
        where demo_knock_down_date::timestamp >= date '2014-01-01'
            and socrata_reported_price > 0
            and demo_contractor_text_only <> '' )
